#+SETUPFILE: ~/.emacs.d/themes/org-html-themes/setup/theme-readtheorg.setup
#+OPTIONS: \n:t
#+OPTIONS: tex:t
#+STARTUP: latexpreview
#+OPTIONS: tex:dvipng
#+HTML_MATHJAX: align: left indent: 5em tagside: left font: Neo-Euler

* SI - 信号完整性揭秘
  *信号完整性问题的根源在于信号上升时间减小导致高频成分增多，而其他众多的影响因素则加剧了信号完整性的问题.*

** 难点
   幅度、 噪声、 边沿、 延时

   | 信号要求 | 关注点                                 |
   |----------+----------------------------------------|
   | 电平     | 时间窗口的宽度，可以容忍适度的幅度噪声 |
   | 边沿     | 边沿的单调性                           |

** 误区
   - 认为只要跟着设计流程做，就可以做好SI设计
   - 没有针对性，不分轻重
   - 盲从于设计规则
   - 不重视量化评估
   - 片面追求解决个别问题，忽视其他问题

** 关注点
   | 类型         | 关注点                                                               |
   |--------------+----------------------------------------------------------------------|
   | 局部总线     | 信号本身的质量，对反射、串扰、电源滤波                               |
   | 时钟频率很高 | 总线的时序上，改善信号本身质量的目的最终还是为了满足时序要求         |
   | 时钟电路     | 保证时钟边沿的单调性、时钟频谱的纯净度、时钟的抖动                   |
   | GHz高速串行  | 通道损耗和阻抗连续性,参考时钟、电源质量,预加重和均衡参数的调整和优化 |

** 数字信号频谱与带宽
   - 周期
   \[ x(t + nT) = x(t) n = 0, \pm1, \(...\) \]
   - 频率
   \[ $$ f$_{0}$ = 1/T \]
   - 角频率
   \[ $$ w$_{0}$ = 2\pi f$_{0}$ = 2\pi/T    \]
   - 周期信号
   \[ $$ x(t) = a$_{0}$ + \displaystyle\sum_{n=1}^{\infty} [a$_{n}cos(nw$_{0}$t) + b$_{n}sin(nw$_{0}$t)]\]
   或
   \[ $$ x(t) = c$_{0}$ + \displaystyle\sum_{n=1}^{\infty} [c$_{n}cos(nw$_{0}$t) + \phi_{n}]\]

   信号的直流分量就是信号的平均值
   | *幅度谱* | \[$$ c$_{n}\] 和 \[$$ nw$_{0} \]的关系 |
   |----------+----------------------------------------|
   | *相位谱* | \[$$ nw$_{0} \] 和 \[\phi_{n}\]的关系  |

*** 方波
    - *频谱*
      [[./serdes.img/squarewave.jpeg]]
    - *吉布斯现象*
      将具有不连续点的周期函数（如矩形脉冲)进行傅立叶级数展开后，选取有限项进行合成.当选取的项数越多，在所合成的波形中出现的峰起越靠近原信号的不连续点.当选取的项数很大时，该峰起值趋于一个常数，大约等于总跳变值的9%.
      对于周期信号，其幅度频谱只在一系列离散点取值.
    - *方波*
      /*方波信号频率趋于无穷大时方波信号的频谱幅度以-20dB/十倍频程的速度衰减*/
      理论上理想方波信号带宽是无穷大的.尽管如此，无穷大的带宽对实际工程应用没有什么实际意义，信号频谱中各个频率分量的贡献是不同的.
      /note: 这里的带宽指的是频率范围/
      *所选信号带宽越大，波形上升时间越小.或者说，波形上升时间越小，信号带宽越大.上升时间越小，信号带宽越大，说明高频成分对信号的贡献越大.如果信号上升时间较长，使用相对较小的带宽就可以合成信号波形*
      信号带宽的定义常见有\[ $$ 0.35/T_{r} \](本质为3db低通滤波, \[ $$ T_{r}\] 指的是10%~90%信号上升时间)和\[ $$ 0.5/T_{r} \](等效噪声带宽).
    - *为何定义数字信号带宽*
      提供一种参考标信：在该频率范围内的频率成分很可能会对最终的设计产生很大的影响
*** 小结
    - 时域信号可看作由很多频谱分量叠加而形成，这种时频域之间的转换关系对于理解很多SI现象和SI解决措施非常有帮助.
    - 理想方波和梯形波频谱包络典型区别在于梯形波频谱包络在特定频点后衰减特性变为-40dB/十倍频程，第二个转折点和上升时间有关.
    - 信号上升时间和带宽的关系.信号上升时间越小，带宽越大，包含的高频成分越多.
    - 带宽的概念.定义带宽的方式有多种，带宽并不是“非黑即白”的分界线，信号中的频率分量对于信号作用大小是渐进变化的.
** 传输线
   最简单的传输线由一对导体构成，把信号以电磁波的形式从一端送到另一端.想象我们向平静的水面投下一颗石子，石子落入水面的瞬间，水的局部被压缩，石子的动能传递给被压缩的水体，被压缩的水松弛，能量被释放并压缩周边水体，周边的水体重复这一过程.最终我们看到的是水在垂直方向上起落波动，这一过程向外扩散形成波纹.投入的石子仅仅是这一波动过程的激励源.传输线上的信号电压就像是“浪头”一样，以介质中的光速快速向前传播，在信号传输的某一瞬间，传输线上只有某一区域内存在电压变化，随着时间的推移这一区域也向前推进，传输线上信号的传输是一个瞬态的过程，每一个瞬间信号电压的“浪头”所在位置不同，感受到的“环境”也可能不同，因此，传输线局部环境变化 _*如阻抗变化*_ 会影响信号的行为，并最终反映到信号的电压波形中.
   *PCB上信号的传播速度约为\[ $$ 6 inch/ns \]*,对于高频信号，多用内部走线，低速的才用表面走线.
   电流回路的建立并不是电流先流到末端通过末端的连接从返回路径流回.当信号电压施加在传输线入口的瞬间，信号路径和参考路径之间产生电位差，同时伴随着电荷的积聚，从而产生电流，这类似于电容的充电.
   如果导体上有电流，导体周围会产生磁场，磁场可以认为是由许多“力线”构成.当电流穿过与其垂直的某一平面时，在该平面内“激起”一个“磁漩涡”，形成许多闭合的环形磁力线，电流称为磁场的漩涡源.
   PCB两根走线间会产生电容和电感，从而有 *单位长度电容与单位长度电感*.
   *如果传输线是均匀的，则沿着前方向传输线的结构始终不变，那么电压中反向传输的分量不存在.如果在某一点处两侧的传输线结构发生变化，就会产生这个后向传输的分量.电报方程为理解信号反射、传输线特性阻抗、传输线延时等概念提供了理论基础.*
*** 影响特性阻抗的因素
    - 线宽
      线宽越大，电感就越小。线宽越大，电流就越分散，电感越小。线宽越小，电流越集中，电感越大。线宽为4mil时特性阻抗约为61.5Ω，线宽为12mil时特性阻抗约为33Ω.
    - 介质厚度
      介质厚度增大时，两个导体的间距加大，从3.8节我们知道导体间距增大，互感Lm减小，单位长度电感就会增加。电容减小。因而介质厚度增大最终的结果导致传输线特性阻抗增大。
    - 介电常数
      介电常数越大，单位长度电容越大，特性阻抗越小。
    - 铜箔厚度
      走线的铜箔厚度越大，阻抗减小。
*** 参考平面
    | 表层走线 | 一个参考平面 |
    |----------+--------------|
    | 内层走线 | 两个参考平面 |

    PCB上信号沿传输线向前传输时，电力线起始于信号走线，终结于参考平面，信号线和参考平面构成了电磁波向前传播的物理环境。
    - 作用
      | 承载返回电流     |
      | 控制阻抗         |
      | *构成传输线结构* |
    参考平面一定是返回路径，但是返回路径不仅仅包含参考平面，可能还包含与信号线同层的邻近导体.

*** 返回电流
    返回电流分布在两个平面，总的返回电流一定等于信号电流，信号电流确定了，返回电流大小也就相应确定了。
*** 阻抗\[$$ Z_{0}\]、电容C、电感L
    光速\[ $$ c_{0} \]
    介电常数\[ $$ \epsilon_{r}\]
    - 单位电感
      \[ $$ L = Z_{0}\sqrt{\epsilon_{r}}/c_{0} \]
    - 单位电容
      \[ $$ C = \sqrt{\epsilon_{r}}/c_{0}Z_{0} \]
*** 理想传输线集总模型
    [[./serdes.img/idealtransmitlinemodel.jpeg]]

    传输线分段分析长度要远小于信号中最高感兴趣频率对应的波长,一般1/10。比如PCB上信号传输速度为6inch/ns，如果信号上升时间1ns，信号的3dB带宽为350MHz，对应波长约17inch，那么使用等效模型近似时，传输线分段的长度不能超过1.7inch。
*** 耦合传输线
    考虑两条传输线，其中一条线的分布参数受邻近线工作状态的影响。第1种工作状态邻近线处于“静态”，其作用就像一个额外的分布式容性负载，分布电感不变。第2种工作状态两条线上信号同时反向跳变，这种状态称为“奇模”工作状态，其中一条线“感受”到的等效分布电感减小，分布电容增加。第3种工作状态两条线上信号同时同向跳变，这种状态称为“偶模”工作状态，其中一条线“感受”到的分布电感增大，分布电容则不变。
*** 阻抗的影响
    | 耦合传输线模态 | 阻抗 |
    |----------------+------|
    | 静态           | 下降 |
    | 奇偶           | 最小 |
    | 偶模           | 最大 |
    内层走线的阻抗受模态变化影响较小，更容易保持传输线阻抗的稳定性。
*** 传输线损耗
    | 类型       | 来源                                 | 解决方案 | 影响 |
    |------------+--------------------------------------+----------+------|
    | 阻性       | 电阻,趋肤效应,邻近效应,表面粗糙度    | 均衡     |      |
    | 介质       | 介质极化(取向极化，位移极化)，漏电流 | 均衡     |      |
    | 阻抗不连续 |                                      |          |      |
    | 串扰       |                                      |          |      |
    | 反射       |                                      |          |      |
    | 辐射       |                                      |          | 小   |

    /趋肤效应会造成过流面积减小，从而电阻，特别是交流电阻增加。/
    /介质中少量自由移动的电荷，在外电场的作用下，形成极小的漏电流。/
*** 有损传输线集总模型
    [[./serdes.img/realtransmitlinemodel.jpeg]]

    特性阻抗和频率有关，低频时特性阻抗较大.
    信号传播的速度与信号的频率有关，不同频率的信号传播速度不同。频率越高速度越快。

** 信号的反射与端接
   信号振铃,台阶性波形,边沿回钩
   /*note: 反射电压都是持续的,比如末端开路，第一次出现反射时电压为输出电压的两倍，除非再有电压反射回来，电压保持两倍*/
*** 形成
    /*实际上反射的最直接的原因就是互连线中阻抗发生了突然变化。只要互连线中存在阻抗不连续的点，该处就会发生反射。*/
    反射系数: \[ $$\Gamma = V_{reflect}/V_{inc} = (Z_{2} - Z_{1}) / (Z_{2} + Z_{1})  \]
    末端开路时，反射系数为1，总电压叠加，末端短路时，反射系数为-1，总电压为0.
*** 正反射与负反射
    在阻抗不连续的点处发生反射时，反射的是信号的波形，而不是电压数值。
    对于正反射，副本变化方向和入射信号变化方向相同。对于负反射，副本变化方向和入射信号变化方向相反。
    不论入射信号是什么样的波形，只要反射系数是恒定的数值，反射信号波形就是入射信号波形的一个副本。不论是发送端还是接收端，最终得到的波形都是入射波形和反射波形叠加的结果。如果发生多次反射，也仅仅是这一叠加过程稍微复杂一些而已，但波形叠加的本质不会变。
*** 容性阻抗
    电压刚刚施加到电容上的瞬间，电容的阻抗为0，相当于短路。随着电容充电，阻抗逐渐增大。随着时间的不断增加，阻抗逐渐变为无穷大，最终相当于开路。
    对于容性负载来说，由于阻抗是时变的，所以导致反射系数也是时变的,较长的上升时间可以容忍更大的容性不连续，而较小的上升时间对容性不连续相对来说就比较敏感。
    对于300ps的上升时间，传输线末端1pF的电容就会在发送端产生5%的噪声。可见，末端电容的反射噪声对电容值和信号上升时间很敏感，增加信号上升时间能显著减小容性负载的反射噪声。
*** 互连线中间容性负载的反射
    *对于低速信号，过孔也可以粗略地看作是一个容性负载。如果PCB走线经过过孔换层，就类似在传输线中间有一个小的容性负载*
    [[./serdes.img/ec_signal.jpeg]]
    信号每一次传输到电容所在的位置时，都会有一部分信号在发送端叠加在高电平上从而形成噪声。
    对于接收端，容性不连续发生两种作用
    - 信号的上升沿由于电容的作用变缓
    - 高电平和低电平都会叠加一定的噪声。
    信号到达接收端后，由于接收端的高阻抗而发生反射，反射信号幅度等于入射信号幅度。反射回来的信号到达中间的电容时再次发生反射，反射电压为负值，这个信号传播到接收端并叠加在接收端信号上，产生了波形中的第一个回勾。沿着信号传播路径继续走，这个负的信号在接收端再次发生反射，幅度翻倍，再次传播到电容处，在电容处发生负反射变为一个正的信号向接收端传播，在接收端波形上形成一个上冲。
*** 时间延迟
    对于接收端来说，连线中间的容性负载就像是一个延时累加器。

** 附录与缩写
   - 集总电路
     在一般的电路分析中，电路的所有参数，如阻抗、容抗、感抗都集中于空间的各个点上、各个元件上，各点之间的信号是瞬间传递的，这种理想化的电路模型称为集总电路.
   - VCC
     接入电压
   - VDD
     器件内部工作电压
   - 电容
     单位伏特电压情况下导体能存储多少库化电荷,即\[ $$ C = Q/V\]
   - 介电常数
     也称相对介电常数, \[ $$ \epsilon_{r} = C_{sub}/C_{air}\]
   - 电感
     磁通量 ψ 和 电流 I 之间 的 线性 比例 因子, \[ $$ L = \psi/I\]
   - 阻抗
     电阻加电抗,在一般状态下的导体，多少都存有阻止电流流动的作用，而表示其阻止程度者，称为电阻，在交流电路中，除电阻外，还有电感和电容等皆有阻碍电流作用，通常将阻止交流电流作用的部分，总称为阻抗。
   - 1mil=1/1000inch=0.0254mm
   - 趋肤效应
     高频电流流过导体时，电流会趋向于导体表面分布，越接近导体表面电流密度越大。
   - 邻近效应
     信号线上的高频电流集中分布在靠近参考平面的一侧，而参考平面上的高频电流也靠近信号线分布.
   - 取向极化
     极性分子，当施加外电场后，在电场力的作用下，极性分子正负电荷的排列方向发生变化。
   - 位移极化
     非极性分子，当施加外电场后，在电场力的作用下，正负电荷沿电场方向发生位移，负电荷沿反方向发生位移，正负电荷的中心不再重合，变成有极性的分子，
   - 欧姆定律的限制
     在纯电阻中，由欧姆定律得出P=UI，并推导出P=IIR=UU/R；而在非纯电阻中由于电能转化为内能以外的物质，所以有Q<W，欧姆定律的推导式P=IIR=UU/R不适用于此情况，只能用P=UI
   - BER and SER
     BER: bit error ratio
     SER: symbol error ratio

** Q&A
*** 信号路径与参考路径
    电子在导线中移动的速度很慢,而一开开关,电灯就能亮,从开关到灯亮,这是速度是光速,所以本质是在导线中传播是电场,电场的传播速度是光速,电场施加在源端,驱动电子流动,不需要源端的这个电子到末端,灯才会亮,而是电子一个一个驱动到末端,就会亮了,电场过去就行,而谈到场的概念,就是两个了,电势差与电场,电场就是两个电势差不一样的东西之间形成的一个整体,所以板子上面的信号传播是在传播一个电场,信号线和参考地,之间共同形成的一个整体, *所以他们是信号路径和参考路径*,其实本质就是电场,源端形成的一个电场,传输到接收端,信号在板子上面的传播速度也是光速,当然板子的介电常数不是1,而是4,所以比光速要慢,板子上面的信号本质就是在传输一个电场,因为接收端,就是一个差分接收器,差分接收器是电压驱动的电场传到了就能接收到,为啥我们平时开灯关灯,都没有考虑这个场的感念,那是因为我们平常的这些信号速度太慢(50Hz),同一时间,两侧信号发送端和接收端,波形无差异,信号线上的正电荷一个一个往前推动,参考路径上面负电荷一个一个往前推动,这个电场才不断的往前推动,两根线传一个完美的电场,,平常一根线也可以,电线随便接一根都能亮,因为传的就是一个50HZ的正弦波,一根线就是参考平面无穷远,一定要等正电荷到达负载,通过负载之后,再通过另外一根线回来,到这个时候,才源端才能感受到正电荷到来,就是加了一个时间delay,对于高速信号,如果一开始没有感受到,那么信号的上升沿会不完美,对于低速的,这个delay,根本就是毛毛雨,对于高速的这个delay,就很麻烦了,你要想,高速的,再接收端接收到之前,线上已经有好多bit在传输,第一个bit 还没有到达接收端,第二个,第三个,第四个bit 都已经发送到线上了,所以说高速信号才要两根线,在33MHz之前,走线还是1根,比如走线在 第一层,一根线,然后板子第二层是GND,第一层的这跟线和第二层的GND 形成一个电场传输器,实际看还是一根,高速线,两根是差分,第一个层两根,第二层GND,可以更好的抵抗干扰,芯片的驱动门也是接到电源和地之间的,驱动电源到信号线上,信号线和参考地,就能形成电场,这个电场就能往前传.
    [[https://zhuanlan.zhihu.com/p/31896563][回流路径扩展阅读]]
*** 单位电容和特性阻抗
    传输线就是电容，电感，电容，电感，等效出来的, 电容的拉氏变化之后是1/sC,电感的拉氏变化是sL,C越大，阻抗越低,无穷大的一个电容就是短路，传输线50欧是阻抗50ohm,不是电阻值50ohm,阻抗和电阻不是一回事儿,传输线，一般就是用电容，电感去等效，电阻值等于0的,你用万用表去量电阻，就是0，但是阻抗虽然也是是U/I，但是是拉氏域的U/I,不是时域的,你看一个电感，加一个直流电压之后，电阻就是0,正选波加上去之后，就是sL,s=jwL,所以这个阻抗50欧说明变化的电场，看到的阻抗是50ohm,讲的是正弦波看到的阻抗,电路理论说的是时域分析，就是电阻，电感，电容，但是到了频域，电阻，电感，电容，大一统，统统叫阻抗,R的阻抗还是R，C的阻抗是1/sC，L的阻抗是sL,讲的是他们对交变信号的，上跳沿，可以傅里叶展开成一堆正弦波的叠加,只要知道它对正弦波的响应，就能反推出来时域的波形,50ohm是工程技术上面采用的一个最容易实现的,小了，线宽就要变大，大了，线宽就要变小,工艺上，普遍是用4mil的宽度的线,太宽了，相同空间，走的线个数就少了，太窄了，工艺做不到,然后pcb上面的层与层之间填充的介质，介电常数3.8-4,这些限制决定了，50是一个比较优化的实现方式,当然曾经也有人做过75的,不过50是工业主流,因为时域太难算了所以引入频域，方便理解分析.
*** 阻抗不连续会引起反射，那为什么电阻不会

